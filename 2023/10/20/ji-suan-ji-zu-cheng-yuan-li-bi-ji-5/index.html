<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="计算机组成原理 笔记5, Endeavor">
    <meta name="description" content="sram 控制器">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>计算机组成原理 笔记5 | Endeavor</title>
    <link rel="icon" type="image/png" href="/favicon.png">
    
    <style>
        body{
            background-image: url(https://cdn.jsdelivr.net/gh/chengsx21/ImageBed/pic/202406301735336.png);
            background-repeat:no-repeat;
            background-size: 100% 100%;
            background-attachment:fixed;
        }
    </style>



    <!-- bg-cover style     -->



<link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.min.css">
<link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
<link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
<link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
<link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
<link rel="stylesheet" type="text/css" href="/css/matery.css">
<link rel="stylesheet" type="text/css" href="/css/my.css">
<link rel="stylesheet" type="text/css" href="/css/dark.css" media="none" onload="if(media!='all')media='all'">




    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
    <link rel="stylesheet" href="/css/post.css">




    
        <link rel="stylesheet" type="text/css" href="/css/reward.css">
    



    <script src="/libs/jquery/jquery-3.6.0.min.js"></script>

<meta name="generator" content="Hexo 6.3.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
<link rel="alternate" href="/atom.xml" title="Endeavor" type="application/atom+xml">
</head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">Endeavor</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/contact" class="waves-effect waves-light">
      
      <i class="fas fa-comments" style="zoom: 0.6;"></i>
      
      <span>留言板</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/GifExplorer-docs" class="waves-effect waves-light">
      
      <i class="fas fa-film" style="zoom: 0.6;"></i>
      
      <span>GifDocs</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/sast-summer-training-2023" class="waves-effect waves-light">
      
      <i class="fas fa-book" style="zoom: 0.6;"></i>
      
      <span>SkillDocs</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
  <li>
    <a href="javascript:;" class="waves-effect waves-light" onclick="switchNightMode()" title="深色/浅色模式" >
      <i id="sum-moon-icon" class="fas fa-sun" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">Endeavor</div>
        <div class="logo-desc">
            
            Blog of Chengsx
            
        </div>
    </div>

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/contact" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-comments"></i>
			
			留言板
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/GifExplorer-docs" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-film"></i>
			
			GifDocs
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/sast-summer-training-2023" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-book"></i>
			
			SkillDocs
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/chengsx21/" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/chengsx21/" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/16.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">计算机组成原理 笔记5</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/Organization-Design/">
                                <span class="chip bg-color">Organization &amp; Design</span>
                            </a>
                        
                            <a href="/tags/SV/">
                                <span class="chip bg-color">SV</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/CS/" class="post-category">
                                CS
                            </a>
                        
                            <a href="/categories/CS/Organization-Design/" class="post-category">
                                Organization & Design
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2023-10-20
                </div>
                

                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-check fa-fw"></i>更新日期:&nbsp;&nbsp;
                    2024-06-30
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    4.4k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    17 分
                </div>
                

                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">

        
        <!-- 是否加载使用自带的 prismjs. -->
        <link rel="stylesheet" href="/libs/prism/prism.min.css">
        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="SRAM-控制器"><a href="#SRAM-控制器" class="headerlink" title="SRAM 控制器"></a>SRAM 控制器</h1><h2 id="SRAM"><a href="#SRAM" class="headerlink" title="SRAM"></a>SRAM</h2><h3 id="SRAM-的结构"><a href="#SRAM-的结构" class="headerlink" title="SRAM 的结构"></a>SRAM 的结构</h3><p>可以把 SRAM 想象成一个数组: <code>uint32_t sram[1048576]</code>, 即 1048576 个 32 位整数, 一共是 <code>32 * 1048576 / 8 = 4 MB</code> 的数据. 我们可以对其进行读和写的操作, 就好像 C 的代码: </p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token class-name">uint32_t</span> sram<span class="token punctuation">[</span><span class="token number">1048576</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token comment">// read</span>
<span class="token class-name">uint32_t</span> read_data <span class="token operator">=</span> sram<span class="token punctuation">[</span>addr<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token comment">// write</span>
sram<span class="token punctuation">[</span>addr<span class="token punctuation">]</span> <span class="token operator">=</span> write_data<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以想象一下 SRAM 的工作流程, 假如有一个二维的矩阵, 一共有 1048576 个行, 每行有 32 列, 每一个矩阵元素就是 0 或者 1, 这样每一行就是一个 32 位整数. </p>
<p>无论是读还是写, 都有若干个步骤, 需要花费一定的时间, 这意味着在操作 SRAM 时需要按照一定的规则, 否则可能导致读取错误, 或没有成功写入等问题. </p>
<h3 id="SRAM-的信号"><a href="#SRAM-的信号" class="headerlink" title="SRAM 的信号"></a>SRAM 的信号</h3><p>顶层模块中有如下的信号: </p>
<pre class="line-numbers language-verilog" data-language="verilog"><code class="language-verilog"><span class="token comment">//BaseRAM信号</span>
<span class="token keyword">inout</span> <span class="token keyword">wire</span><span class="token punctuation">[</span><span class="token number">31</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> base_ram_data<span class="token punctuation">,</span>  <span class="token comment">//BaseRAM 数据</span>
<span class="token keyword">output</span> <span class="token keyword">wire</span><span class="token punctuation">[</span><span class="token number">19</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> base_ram_addr<span class="token punctuation">,</span> <span class="token comment">//BaseRAM 地址</span>
<span class="token keyword">output</span> <span class="token keyword">wire</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> base_ram_be_n<span class="token punctuation">,</span>  <span class="token comment">//BaseRAM 字节使能, 低有效, 默认为 0</span>
<span class="token keyword">output</span> <span class="token keyword">wire</span> base_ram_ce_n<span class="token punctuation">,</span>       <span class="token comment">//BaseRAM 片选, 低有效</span>
<span class="token keyword">output</span> <span class="token keyword">wire</span> base_ram_oe_n<span class="token punctuation">,</span>       <span class="token comment">//BaseRAM 读使能, 低有效</span>
<span class="token keyword">output</span> <span class="token keyword">wire</span> base_ram_we_n<span class="token punctuation">,</span>       <span class="token comment">//BaseRAM 写使能, 低有效</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这是 CPU 访问 SRAM 的途径. 实验板上一共有两组 SRAM, 我们称之为 <strong>BaseRAM</strong> 和 <strong>ExtRAM</strong>, 上面的信号是和 BaseRAM 进行连接的信号.</p>
<ol>
<li><code>inout wire [31:0] base_ram_data</code>: 读写的 32 位数据, 用的是同一组信号, <strong>同一时间只能进行读写其中一个</strong>.</li>
<li><code>output wire [19:0] base_ram_addr</code>: 地址线, 正好是 <code>uint32_t sram[1048576]</code> 的数组大小.</li>
<li><code>output wire [3:0] base_ram_be_n</code>: 字节使能, 目的是实现<strong>部分写入</strong>, 例如只想写入四个字节其中一个, 就把相应位设置为 <code>0</code>.</li>
<li><code>output wire base_ram_ce_n</code>: 片选使能, 需要保证 <code>base_ram_ce_n=0</code>; 如果 <code>base_ram_ce_n=1</code>, 就进入<strong>省电模式</strong>.</li>
<li><code>output wire base_ram_oe_n</code>: 输出使能, 读操作需保证 <code>base_ram_oe_n=0</code>, 此时 <code>base_ram_data</code> <strong>由 SRAM 输出</strong>; 写操作需保证 <code>base_ram_oe_n=1</code>, 此时 <code>base_ram_data</code> <strong>由 FPGA 输出</strong>.</li>
<li><code>output wire base_ram_we_n</code>: 写入使能, 读操作对应 <code>base_ram_we_n=1</code>, 写操作对应 <code>base_ram_we_n=0</code>.</li>
</ol>
<p>如果<strong>不考虑 SRAM 操作所需要的时间</strong>, 大概操作思路如下: </p>
<p>读操作:</p>
<ol>
<li>设置 <code>base_ram_addr</code> 为要读取的地址, 设置 <code>base_ram_be_n=0b0000</code>, <code>base_ram_ce_n=0</code>, <code>base_ram_oe_n=0</code>, <code>base_ram_we_n=1</code>.</li>
<li>等待读取完毕, 在 <code>base_ram_data</code> 上得到读取的数据.</li>
</ol>
<p>写操作:</p>
<ol>
<li>设置 <code>base_ram_addr</code> 为要写入的地址, 设置 <code>base_ram_ce_n=0</code>, <code>base_ram_oe_n=1</code>, <code>base_ram_we_n=0</code>, 根据要写入的字节数量设置 <code>base_ram_be_n</code>.</li>
<li>等待写入完毕.</li>
</ol>
<h3 id="SRAM-的时序"><a href="#SRAM-的时序" class="headerlink" title="SRAM 的时序"></a>SRAM 的时序</h3><p>SRAM 实际上读写需要经过几个步骤, 这意味着不能简单地直接给出信号, 完成读和写的操作. 接下来分析一下 SRAM 读写需要的具体步骤和相应的波形. </p>
<h4 id="读时序"><a href="#读时序" class="headerlink" title="读时序"></a>读时序</h4><p>SRAM 读取时, 首先找到相应的行, 再把一行的数据输出到 <code>base_ram_data</code> 上. 这一步需要大约一个周期的时间. 这意味着需要等待一个周期, 在第二个周期才可以得到读取的数据:</p>
<p><img src="https://cdn.jsdelivr.net/gh/chengsx21/ImageBed/pic/202406301624677.png" alt=""></p>
<p>观察上面的波形: </p>
<ol>
<li>每次读取都需要等待一个周期. 等待的时候, <strong>地址保持不变</strong>.</li>
<li>读操作需要保持 <code>ce_n=0</code>, <code>oe_n=0</code>, <code>we_n=1</code>.</li>
<li>四个字节都读取, 于是设置 <code>be_n=0b0000</code>.</li>
<li>不需要读取的时候, 设置 <code>ce_n=1</code>.</li>
</ol>
<h4 id="写时序"><a href="#写时序" class="headerlink" title="写时序"></a>写时序</h4><p>SRAM 写入的过程较为复杂. 可能会只写入部分字节 (如 <code>be_n=0b1100</code>), SRAM 内部操作需要如下三个步骤: </p>
<ol>
<li>根据 <code>addr</code> 找到对应的行, 把一行的数据读取出来.</li>
<li>根据 <code>be_n</code> 计算出新的数据, 如原来保存的数据是 <code>0x12345678</code>, 新写入的数据是 <code>0x87654321</code>, 如果 <code>be_n=0b1100</code>, 则新的数据是 <code>0x12344321</code>.</li>
<li>把新的数据写入到行中.</li>
</ol>
<p>这三个步骤都用一个周期的时间来完成:</p>
<p><img src="https://cdn.jsdelivr.net/gh/chengsx21/ImageBed/pic/202406301624678.png" alt=""></p>
<p>观察上面的波形: </p>
<ol>
<li>每次写入都需要三个周期, 这三个周期内, <strong>地址和数据保持不变</strong>.</li>
<li><code>we_n</code> 三个周期取值分别是 <code>1, 0, 1</code>.</li>
<li>写操作需要保持 <code>ce_n=0, oe_n=1</code>.</li>
<li>四个字节都写入, 设置 <code>be_n=0b0000</code>, 可以根据实际需要设置.</li>
<li>不需要写入的时候, 设置 <code>ce_n=1</code>.</li>
</ol>
<h2 id="Wishbone-总线协议"><a href="#Wishbone-总线协议" class="headerlink" title="Wishbone 总线协议"></a>Wishbone 总线协议</h2><h3 id="为什么需要总线协议"><a href="#为什么需要总线协议" class="headerlink" title="为什么需要总线协议"></a>为什么需要总线协议</h3><p>日常使用的电脑里有各种各样的部件, 例如键盘, 鼠标, 显示器, 无线网卡等等, 它们在操作系统里都是如何识别和管理的? 一些概念, 如 USB、PCIe 等, 用途是给 CPU 一个<strong>通用接口</strong>. 总线的功能:</p>
<ol>
<li>提供一个<strong>统一的硬件接口</strong>, 可以接入不同的<strong>硬件外设</strong>.</li>
<li>提供一个<strong>统一的软件接口</strong>, <strong>操作系统</strong>可以用同样的方式, 来操作这个总线下的所有外设.</li>
</ol>
<p>上面的 USB 总线和 PCIe 总线, 都是属于 <strong>CPU 片外</strong>的总线, 可以在主板上看到. 我们要实现 CPU 片内的总线, 目的是给 <strong>CPU 核心</strong>一个<strong>统一接口</strong>, 来访问内存或者外设.</p>
<h3 id="总线协议是什么"><a href="#总线协议是什么" class="headerlink" title="总线协议是什么"></a>总线协议是什么</h3><p><strong>从 CPU 到内存</strong>需要传输的信息:</p>
<ol>
<li>地址 <code>addr</code>:  按照内存的大小计算地址线的宽度, 例如 4GB 内存是 <code>2^32</code> 字节, 需要 32 位的地址.</li>
<li>写入的数据 <code>w_data</code>.</li>
<li>读还是写 <code>we</code>: 高表示写, 低表示读.</li>
</ol>
<p><strong>从内存到 CPU</strong> 需要传输的信息: </p>
<ol>
<li>读/写操作完成.</li>
<li>读取的数据 <code>r_data</code>.</li>
</ol>
<h3 id="如何设计一个总线协议"><a href="#如何设计一个总线协议" class="headerlink" title="如何设计一个总线协议"></a>如何设计一个总线协议</h3><p>当 CPU 不访问内存的时候, 可以让内存休息, 减少能耗. 因此需要设计一个控制信号 <code>valid</code>, 高表示 CPU 请求一次读写操作, 低表示不请求. </p>
<p>内存的访问相对 CPU 来说是很慢的, 需要一个机制, 让 CPU 等待内存的访问过程. 当 CPU 要进行读写操作时, 会设置 <code>valid=1</code>, 此时内存进行实际的内存操作, 一段时间后通知 CPU 操作完成, 同时返回结果. 于是添加一个信号 <code>ready</code>, 高表示内存完成一次读写操作, 低表示还没完成或者 CPU 没有请求. 当内存完成读写时, 设置 <code>ready=1</code>, 标志着一次读写操作的完成. </p>
<p>CPU 进行一次读写操作需要经历的过程: </p>
<ol>
<li>CPU 设置 <code>valid=1</code>, 内存开始读写操作.</li>
<li>内存完成操作以后, 设置 <code>ready=1</code>, 表示操作已经完成.</li>
<li>CPU 看到内存设置 <code>ready=1</code> 时, 知道操作已完成, 设置 <code>valid=0</code>.</li>
<li>CPU 下一次进行读写操作, 再从第一步开始.</li>
</ol>
<p>这种操作方式也可以用于 CPU 访问外设, 下面用 <strong>master</strong> 表示 <strong>CPU 端</strong>, 也就是发起请求的一端; 用 <strong>slave</strong> 表示<strong>设备端</strong>, 包括内存、外设等, 也就是处理请求的一端. 回到硬件, 综合以上的分析, 可以得到 <strong>master 端的信号</strong>, 约定 <code>_o</code> 表示输出, <code>_i</code> 表示输入:</p>
<ol>
<li><code>clock_i</code>: 时钟输入.</li>
<li><code>valid_o</code>: 高表示 master 想要发送请求.</li>
<li><code>ready_i</code>: 高表示 slave 完成处理请求.</li>
<li><code>addr_o</code>: master 想要读写的地址.</li>
<li><code>we_o</code>: master 想要读还是写.</li>
<li><code>data_o</code>: master 想要写入的数据.</li>
<li><code>be_o</code>: master 读写的字节使能, 用于实现单字节写等.</li>
<li><code>data_i</code>: slave 提供给 master 的读取的数据.</li>
</ol>
<p>根据设计的自研总线, 可以绘制出下面的波形图 (以 master 的信号为例): </p>
<p><img src="https://cdn.jsdelivr.net/gh/chengsx21/ImageBed/pic/202406301624679.png" alt=""></p>
<ul>
<li><code>a</code> 周期: 此时 <code>valid_o=1 &amp;&amp; ready_i=1</code> 说明有请求发生, 此时 <code>we_o=1</code> 说明是一个写操作, 写入地址是 <code>addr_o=0x01</code>, 写入数据是 <code>data_o=0x12</code>.</li>
<li><code>b</code> 周期: 此时 <code>valid_o=0 &amp;&amp; ready_i=0</code> 说明无事发生.</li>
<li><code>c</code> 周期: 此时 <code>valid_o=1 &amp;&amp; ready_i=0</code> 说明 master 想从 <code>addr_o=0x02</code> 读取数据, 但是 slave 没有完成 <code>ready_i=0</code>.</li>
<li><code>d</code> 周期: 此时 <code>valid_o=1 &amp;&amp; ready_i=1</code> 说明有请求发生, master 从地址 <code>addr_o=0x02</code> 读取数据 <code>data_i=0x34</code>.</li>
<li><code>e</code> 周期: 此时 <code>valid_o=0 &amp;&amp; ready_i=0</code> 说明无事发生.</li>
<li><code>f</code> 周期: 此时 <code>valid_o=1 &amp;&amp; ready_i=1</code> 说明有请求发生, master 向地址 <code>addr_o=0x03</code> 写入数据 <code>data_i=0x56</code>.</li>
<li><code>g</code> 周期: 此时 <code>valid_o=1 &amp;&amp; ready_i=1</code> 说明有请求发生, master 从地址 <code>addr_o=0x01</code> 读取数据 <code>data_i=0x12</code>.</li>
<li><code>h</code> 周期: 此时 <code>valid_o=1 &amp;&amp; ready_i=1</code> 说明有请求发生, master 向地址 <code>addr_o=0x02</code> 写入数据 <code>data_i=0x9a</code>.</li>
</ul>
<p>从波形中有几点观察: </p>
<ol>
<li>master 发起请求时, 设置 <code>valid_o=1</code>; slave 可完成请求时, 设置 <code>ready_i=1</code>; 在 <code>valid_o=1 &amp;&amp; ready_i=1</code> 时请求完成, 进行下一个请求.</li>
<li>如果 master 发起请求, slave 不能接收请求, 即 <code>valid_o=1 &amp;&amp; ready_i=0</code>, 此时保持 <code>addr_o</code>, <code>we_o</code>, <code>data_o</code> 和 <code>be_o</code> 不变, 直到请求结束.</li>
<li>master 不发起请求时, 即 <code>valid_o=0</code>, 此时总线信号都视为无效数据, 不应该进行处理; 读操作只有在 <code>valid_o=1 &amp;&amp; ready_i=1</code> 时数据有效.</li>
<li>可以连续多个周期发生请求, 即 <code>valid_o=1 &amp;&amp; ready_i=1</code> 连续多个周期. 此时是理想情况, 可以达到总线最高的传输速度.</li>
</ol>
<h3 id="Wishbone-总线协议-1"><a href="#Wishbone-总线协议-1" class="headerlink" title="Wishbone 总线协议"></a>Wishbone 总线协议</h3><p>实践中很常用的总线协议 Wishbone 和上面自研的总线十分类似, 以 master 端为例: </p>
<ol>
<li><code>CLK_I</code>: 时钟输入, 即自研总线中的 <code>clock_i</code>.</li>
<li><code>STB_O</code>: 高表示 master 要发送请求, 即自研总线中的 <code>valid_o</code>.</li>
<li><code>ACK_I</code>: 高表示 slave 完成请求, 即自研总线中的 <code>ready_i</code>.</li>
<li><code>ADR_O</code>: master 想要读写的地址, 即自研总线中的 <code>addr_o</code>.</li>
<li><code>WE_O</code>: master 想要读还是写, 即自研总线中的 <code>we_o</code>.</li>
<li><code>DAT_O</code>: master 想要写入的数据, 即自研总线中的 <code>data_o</code>.</li>
<li><code>SEL_O</code>: master 读写的字节使能, 即自研总线中的 <code>be_o</code>.</li>
<li><code>DAT_I</code>: master 从 slave 读取的数据, 即自研总线中的 <code>data_i</code>.</li>
<li><code>CYC_O</code>: 总线的使能信号, 无对应的自研总线信号.</li>
</ol>
<p><code>CYC_O</code> 可以认为是 master 想要占用 slave 的总线接口, 在常见的使用场景下, 直接认为 <code>CYC_O=STB_O</code>: </p>
<ol>
<li>占用 slave 的总线接口, <strong>不允许其他 master 访问</strong>.</li>
<li>简化 interconnect 的实现.</li>
</ol>
<p>把自研总线的波形图改成 Wishbone: </p>
<p><img src="https://cdn.jsdelivr.net/gh/chengsx21/ImageBed/pic/202406301624680.png" alt=""></p>
<p>建议 Wishbone 协议每次请求结束, master 拉低 <code>CYC_O</code> 和 <code>STB_O</code>, 因此不能像上面 <code>f-g-h</code> 连续三个周期发生请求. 好处: </p>
<ol>
<li>slave 实现简单, 例如状态机中拉高 <code>ACK</code> 后回到 <code>IDLE</code> 状态即可, 一些简单的 slave 也会默认 master 会在每个请求结束后拉低 <code>CYC_O</code> 和 <code>STB_O</code>.</li>
<li>防止一个 master 占用总线太长时间.</li>
<li>波形图上每个请求区分开来, 方便阅读. </li>
</ol>
<p>最后得到如下的波形:</p>
<p><img src="https://cdn.jsdelivr.net/gh/chengsx21/ImageBed/pic/202406301624681.png" alt=""></p>
<h3 id="Wishbone-总线规范"><a href="#Wishbone-总线规范" class="headerlink" title="Wishbone 总线规范"></a>Wishbone 总线规范</h3><p>一个规范的 Wishbone Master 需要保证:</p>
<ol>
<li><strong>不能打断</strong>正在进行的请求: 上个周期 <code>CYC_O=1 &amp;&amp; STB_O=1 &amp;&amp; ACK_I=0</code>, 这个周期维持 <code>CYC_O=1 &amp;&amp; STB_O=1</code>.</li>
<li><strong>不能修改</strong>正在进行的请求: 上个周期 <code>CYC_O=1 &amp;&amp; STB_O=1 &amp;&amp; ACK_I=0</code>, 这个周期 <code>ADR_O, WE_O, DAT_O, SEL_O</code> 应和上个周期相同.</li>
<li><strong>仅在</strong> <code>CYC_O=1 &amp;&amp; STB_O=1 &amp;&amp; ACK_I=1</code> 时, Slave 提供的 <code>DAT_I</code> 信号有效, 其他取值不应影 Master 的行为.</li>
</ol>
<p>一个规范的 Wishbone Slave 需要保证: </p>
<ol>
<li><strong>仅在</strong> <code>CYC_I=1 &amp;&amp; STB_I=1</code> 时, Master 提供的 <code>ADR_I, WE_I, DAT_I, SEL_I</code> 信号有效, 其他取值不应影响 Slave 的行为.</li>
</ol>
<h2 id="Wishbone-SRAM-控制器"><a href="#Wishbone-SRAM-控制器" class="headerlink" title="Wishbone SRAM 控制器"></a>Wishbone SRAM 控制器</h2><h3 id="Wishbone-Slave"><a href="#Wishbone-Slave" class="headerlink" title="Wishbone Slave"></a>Wishbone Slave</h3><p>Wishbone 分为 Master 和 Slave 两端, 要实现 SRAM 的控制器处理请求 Slave, 回顾 Wishbone 总线协议 Slave 端的信号, 除时钟信号外, 都是输入变输出, 输出变输入:</p>
<ol>
<li><code>CLK_I</code>: 时钟输入, 即自研总线中的 <code>clock_i</code>.</li>
<li><code>STB_I</code>: 高表示 master 要发送请求, 即自研总线中的 <code>valid_o</code>.</li>
<li><code>ACK_O</code>: 高表示 slave 完成请求, 即自研总线中的 <code>ready_i</code>.</li>
<li><code>ADR_I</code>: master 想要读写的地址, 即自研总线中的 <code>addr_o</code>.</li>
<li><code>WE_I</code>: master 想要读还是写, 即自研总线中的 <code>we_o</code>.</li>
<li><code>DAT_I</code>: master 想要写入的数据, 即自研总线中的 <code>data_o</code>.</li>
<li><code>SEL_I</code>: master 读写的字节使能, 即自研总线中的 <code>be_o</code>.</li>
<li><code>DAT_O</code>: master 从 slave 读取的数据, 即自研总线中的 <code>data_i</code>.</li>
<li><code>CYC_I</code>: 总线的使能信号, 无对应的自研总线信号.</li>
</ol>
<p>Wishbone 要点: </p>
<ol>
<li>当 <code>STB_I=1, CYC_I=1</code> 时, 表示 master 正在发起请求.</li>
<li>当 <code>STB_I=1, CYC_I=1, ACK_O=1</code> 时, 表示 slave 完成了当前的请求.</li>
</ol>
<p>采用状态机: </p>
<ol>
<li>第一个状态 <code>IDLE</code>, 表示闲置.</li>
<li>当 <code>STB_I=1, CYC_I=1</code> 时, master 发起请求, 根据请求类型分别处理读和写, 需要状态 <code>READ</code> 和 <code>WRITE</code>.</li>
<li>读需要两个周期, 写需要三个周期, 添加状态 <code>READ_2</code>, <code>WRITE_2</code> 和 <code>WRITE_3</code>.</li>
<li>读写完成转移到 <code>DONE</code> 状态, 设置 <code>ACK_O=1</code>, 然后回到 <code>IDLE</code> 状态.</li>
</ol>
<p><img src="https://cdn.jsdelivr.net/gh/chengsx21/ImageBed/pic/202406301624683.png" alt=""></p>
<p>在 SystemVerilog 中定义各个状态: </p>
<pre class="line-numbers language-verilog" data-language="verilog"><code class="language-verilog"><span class="token keyword">typedef</span> <span class="token keyword">enum</span> <span class="token keyword">logic</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">{</span>
    STATE_IDLE <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
    STATE_READ <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>
    STATE_READ_2 <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span>
    STATE_WRITE <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">,</span>
    STATE_WRITE_2 <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">,</span>
    STATE_WRITE_3 <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">,</span>
    STATE_DONE <span class="token operator">=</span> <span class="token number">6</span>
<span class="token operator">}</span> state_t<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>写出状态转移表:</p>
<pre class="line-numbers language-verilog" data-language="verilog"><code class="language-verilog">state_t state<span class="token punctuation">;</span>

<span class="token important">always_ff @</span> <span class="token punctuation">(</span><span class="token keyword">posedge</span> clock<span class="token punctuation">)</span> <span class="token keyword">begin</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>reset<span class="token punctuation">)</span> <span class="token keyword">begin</span>
        state <span class="token operator">&lt;=</span> STATE_IDLE<span class="token punctuation">;</span>
    <span class="token keyword">end</span> <span class="token keyword">else</span> <span class="token keyword">begin</span>
        <span class="token keyword">case</span> <span class="token punctuation">(</span>state<span class="token punctuation">)</span>
            STATE_IDLE<span class="token punctuation">:</span> <span class="token keyword">begin</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>STB_I <span class="token operator">&amp;&amp;</span> CYC_I<span class="token punctuation">)</span> <span class="token keyword">begin</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>WE_I<span class="token punctuation">)</span> <span class="token keyword">begin</span>
                        state <span class="token operator">&lt;=</span> STATE_WRITE<span class="token punctuation">;</span>
                    <span class="token keyword">end</span> <span class="token keyword">else</span> <span class="token keyword">begin</span>
                        state <span class="token operator">&lt;=</span> STATE_READ<span class="token punctuation">;</span>
                    <span class="token keyword">end</span>
                <span class="token keyword">end</span>
            <span class="token keyword">end</span>
            STATE_READ<span class="token punctuation">:</span> <span class="token keyword">begin</span>
                state <span class="token operator">&lt;=</span> STATE_READ_2<span class="token punctuation">;</span>
            <span class="token keyword">end</span>
            <span class="token comment">// ...</span>
        <span class="token keyword">endcase</span>
    <span class="token keyword">end</span>
<span class="token keyword">end</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="SRAM-控制器-1"><a href="#SRAM-控制器-1" class="headerlink" title="SRAM 控制器"></a>SRAM 控制器</h3><p>在状态机的基础上实现 SRAM 控制器, 采用两周期读、三周期写的实现方式. </p>
<p>对于一次<strong>读操作</strong>, 需要经历如下的四个周期:</p>
<p><img src="https://cdn.jsdelivr.net/gh/chengsx21/ImageBed/pic/202406301624684.png" alt=""></p>
<ol>
<li>(a): master 设置 <code>CYC_I=1</code>, <code>STB_I=1</code>, <code>WE_I=0</code>, 状态是 <code>IDLE</code>, 下个状态是 <code>READ</code>.</li>
<li>(b): 输出 <code>addr</code>, <code>oe_n=0</code>, <code>ce_n=0</code>, <code>we_n=1</code>, 根据 <code>SEL_I=0b1111</code> 可知四个字节都要读取, 输出 <code>be_n=0b0000</code>, 此时状态是 <code>READ</code>, 下一个状态是 <code>READ_2</code>.</li>
<li>(c): SRAM 返回了数据, 把数据保存到寄存器中, 此时状态是 <code>READ_2</code>, 下一个状态是 <code>DONE</code>.</li>
<li>(d): 输出 <code>ce_n=1</code>, <code>oe_n=1</code> 让 SRAM 恢复空闲状态, 设置 <code>ACK_O=1</code>, 此时请求完成, 状态是 <code>DONE</code>, 下一个状态是 <code>IDLE</code>.</li>
</ol>
<p>对于一次<strong>写操作</strong>, 需要经历如下五个周期: </p>
<p><img src="https://cdn.jsdelivr.net/gh/chengsx21/ImageBed/pic/202406301624685.png" alt=""></p>
<ol>
<li>(a): master 设置 <code>CYC_I=1, STB_I=1, WE_I=1</code>, 此时状态是 <code>IDLE</code>, 下一个状态是 <code>WRITE</code>.</li>
<li>(b): 输出 <code>addr</code>, <code>data</code>, <code>oe_n=1</code>, <code>ce_n=0</code>, <code>we_n=1</code>, 根据 <code>SEL_I=0b1111</code> 可知四个字节都要写入, 输出 <code>be_n=0b0000</code>, 此时状态是 <code>WRITE</code>, 下一个状态是 <code>WRITE_2</code>.</li>
<li>(c): 输出 <code>we_n=0</code>, 此时状态是 <code>WRITE_2</code>, 下一个状态是 <code>WRITE_3</code>.</li>
<li>(d): 输出 <code>we_n=1</code>, 此时状态是 <code>WRITE_3</code>, 下一个状态是 <code>DONE</code>.</li>
<li>(e): 输出 <code>ce_n=1</code> 让 SRAM 恢复空闲状态, 设置 <code>ACK_O=1</code>, 此时请求完成, 状态是 <code>DONE</code>, 下一个状态是 <code>IDLE</code>.</li>
</ol>
<p>需要注意, Wishbone 的地址的单位是字节, 而 SRAM 的地址的单位是 4 字节, 地址有一个四倍的关系.</p>
<h3 id="状态机实现技巧"><a href="#状态机实现技巧" class="headerlink" title="状态机实现技巧"></a>状态机实现技巧</h3><p>以写操作为例子, 在上图 <code>b</code> 周期的时候, 状态从 <code>IDLE</code> 变成 <code>WRITE</code>, 并且 <code>ram_ce_n</code> 从 1 变为 0. 在时序逻辑 <code>always_ff @ (posedge clock)</code> 中更新 <code>state</code>: </p>
<pre class="line-numbers language-verilog" data-language="verilog"><code class="language-verilog"><span class="token important">always_ff @</span> <span class="token punctuation">(</span><span class="token keyword">posedge</span> clock<span class="token punctuation">)</span> <span class="token keyword">begin</span>
    <span class="token comment">// ...</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>STB_I <span class="token operator">&amp;&amp;</span> CYC_I<span class="token punctuation">)</span> <span class="token keyword">begin</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>WE_I<span class="token punctuation">)</span> <span class="token keyword">begin</span>
            state <span class="token operator">&lt;=</span> STATE_WRITE<span class="token punctuation">;</span>
        <span class="token keyword">end</span>
    <span class="token keyword">end</span>
<span class="token keyword">end</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>如何修改 <code>ram_ce_n</code>? 一种思路是设定一个寄存器 <code>ram_ce_n_reg</code>, 把寄存器输出直接连接到 <code>ram_ce_n</code> 上. 此时需要保证进入 <code>WRITE</code> 状态时修改 <code>ram_ce_n_reg</code>, 保证 <code>ram_ce_n</code> 和 <code>state</code> 同时更新:</p>
<pre class="line-numbers language-verilog" data-language="verilog"><code class="language-verilog"><span class="token keyword">reg</span> ram_ce_n_reg<span class="token punctuation">;</span>

<span class="token important">always_ff @</span> <span class="token punctuation">(</span><span class="token keyword">posedge</span> clock<span class="token punctuation">)</span> <span class="token keyword">begin</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>reset<span class="token punctuation">)</span> <span class="token keyword">begin</span>
        state <span class="token operator">&lt;=</span> STATE_IDLE<span class="token punctuation">;</span>
    <span class="token keyword">end</span> <span class="token keyword">else</span> <span class="token keyword">begin</span>
        <span class="token comment">// ...</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>STB_I <span class="token operator">&amp;&amp;</span> CYC_I <span class="token operator">&amp;&amp;</span> state <span class="token operator">==</span> STATE_IDLE<span class="token punctuation">)</span> <span class="token keyword">begin</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>WE_I<span class="token punctuation">)</span> <span class="token keyword">begin</span>
                ram_ce_n_reg <span class="token operator">&lt;=</span> <span class="token number">1'b0</span><span class="token punctuation">;</span>
                state <span class="token operator">&lt;=</span> STATE_WRITE<span class="token punctuation">;</span>
            <span class="token keyword">end</span>
        <span class="token keyword">end</span>
    <span class="token keyword">end</span>
<span class="token keyword">end</span>

<span class="token important">always_comb</span> <span class="token keyword">begin</span>
  	ram_ce_n <span class="token operator">=</span> ram_ce_n_reg<span class="token punctuation">;</span>
<span class="token keyword">end</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>好处是从寄存器到输出的<strong>延迟很小</strong>, 适合用于<strong>访问外设</strong>的场景; 缺点是实现需要<strong>根据上一个周期的状态进行判断和更新</strong>, 如果状态比较复杂, 在每个转移的地方都需要相应地设置 <code>ram_ce_n_reg</code>.</p>
<p>另一种方式是用组合逻辑计算出当前的 <code>ram_ce_n</code>: </p>
<pre class="line-numbers language-verilog" data-language="verilog"><code class="language-verilog"><span class="token important">always_comb</span> <span class="token keyword">begin</span>
    <span class="token comment">// default</span>
    ram_ce_n <span class="token operator">=</span> <span class="token number">1'b1</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> STATE_WRITE<span class="token punctuation">)</span> <span class="token keyword">begin</span>
        ram_ce_n <span class="token operator">=</span> <span class="token number">1'b0</span><span class="token punctuation">;</span>
    <span class="token keyword">end</span>
<span class="token keyword">end</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这样的好处是<strong>减少了寄存器的使用</strong>, 并且代码上比较简单; 缺点是把<strong>组合逻辑的延迟</strong>引入了输出的路径上, 可能会使得 SRAM 接口上的<strong>时序变得更长</strong>. </p>
<h3 id="SRAM-控制信号初始化"><a href="#SRAM-控制信号初始化" class="headerlink" title="SRAM 控制信号初始化"></a>SRAM 控制信号初始化</h3><p>实现 SRAM 控制器时, 在 FPGA 刚烧入 Bitstream 的时候, 状态机还没有初始化, 此时的 SRAM 控制信号 <code>ce_n</code>, <code>we_n</code> 和 <code>oe_n</code> 等可能处于 0, SRAM 就会认为此时的 FPGA 在进行写操作, 导致 SRAM 内的数据被覆盖. </p>
<p>解决方法是, 在 <code>initial</code> 和 <code>reset</code> 中对 SRAM 控制信号进行设置:</p>
<pre class="line-numbers language-verilog" data-language="verilog"><code class="language-verilog"><span class="token keyword">initial</span> <span class="token keyword">begin</span>
    ram_ce_n_reg <span class="token operator">=</span> <span class="token number">1'b1</span><span class="token punctuation">;</span>
    ram_oe_n_reg <span class="token operator">=</span> <span class="token number">1'b1</span><span class="token punctuation">;</span>
    ram_we_n_reg <span class="token operator">=</span> <span class="token number">1'b1</span><span class="token punctuation">;</span>
<span class="token keyword">end</span>

<span class="token keyword">assign</span> ram_ce_n <span class="token operator">=</span> ram_ce_n_reg<span class="token punctuation">;</span>
<span class="token keyword">assign</span> ram_oe_n <span class="token operator">=</span> ram_oe_n_reg<span class="token punctuation">;</span>
<span class="token keyword">assign</span> ram_we_n <span class="token operator">=</span> ram_we_n_reg<span class="token punctuation">;</span>

<span class="token important">always @</span> <span class="token punctuation">(</span><span class="token keyword">posedge</span> clock<span class="token punctuation">)</span> <span class="token keyword">begin</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>reset<span class="token punctuation">)</span> <span class="token keyword">begin</span>
        ram_ce_n_reg <span class="token operator">&lt;=</span> <span class="token number">1'b1</span><span class="token punctuation">;</span>
        ram_oe_n_reg <span class="token operator">&lt;=</span> <span class="token number">1'b1</span><span class="token punctuation">;</span>
        ram_we_n_reg <span class="token operator">&lt;=</span> <span class="token number">1'b1</span><span class="token punctuation">;</span>
    <span class="token keyword">end</span>
<span class="token keyword">end</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="三态门"><a href="#三态门" class="headerlink" title="三态门"></a>三态门</h2><p>实现 SRAM 控制器会遇到这样的一个问题: 读写需要经过同样信号 <code>sram_data</code> 传输数据. 在一些接口协议中, 为节省引脚数量, 都出现了同一信号在不同时间传输不同方向数据的现象. 为防止两端设备同时输出, 设备在不输出信号时需要设置高阻态. 在 SystemVerilog 代码中, 通常将三态门 <code>signal_io</code> 拆分成三个信号: <code>signal_i</code>, <code>signal_o</code> 和 <code>signal_t</code>, 分别表示输入、输出和高阻态. 对应的代码如下: </p>
<pre class="line-numbers language-verilog" data-language="verilog"><code class="language-verilog"><span class="token keyword">module</span> tri_state_logic <span class="token punctuation">(</span>
    <span class="token keyword">inout</span> signal_io
<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">wire</span> signal_i<span class="token punctuation">;</span>
    <span class="token keyword">wire</span> signal_o<span class="token punctuation">;</span>
    <span class="token keyword">wire</span> signal_t<span class="token punctuation">;</span>

    <span class="token keyword">assign</span> signal_io <span class="token operator">=</span> signal_t <span class="token operator">?</span> <span class="token number">1'bz</span> <span class="token punctuation">:</span> signal_o<span class="token punctuation">;</span>
    <span class="token keyword">assign</span> signal_i <span class="token operator">=</span> signal_io<span class="token punctuation">;</span>

<span class="token keyword">endmodule</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>内部可以方便地处理三态逻辑. 以 SRAM 为例, <code>sram_data</code> 需要按如下方式处理: </p>
<pre class="line-numbers language-verilog" data-language="verilog"><code class="language-verilog"><span class="token keyword">module</span> sram_controller <span class="token punctuation">(</span>
    <span class="token keyword">inout</span> <span class="token punctuation">[</span><span class="token number">31</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> sram_data
<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">wire</span> <span class="token punctuation">[</span><span class="token number">31</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> sram_data_i_comb<span class="token punctuation">;</span>
    <span class="token keyword">reg</span> <span class="token punctuation">[</span><span class="token number">31</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> sram_data_o_comb<span class="token punctuation">;</span>
    <span class="token keyword">reg</span> sram_data_t_comb<span class="token punctuation">;</span>

    <span class="token keyword">assign</span> sram_data <span class="token operator">=</span> sram_data_t_comb <span class="token operator">?</span> <span class="token number">32'bz</span> <span class="token punctuation">:</span> sram_data_o_comb<span class="token punctuation">;</span>
    <span class="token keyword">assign</span> sram_data_i_comb <span class="token operator">=</span> sram_data<span class="token punctuation">;</span>

    <span class="token important">always_comb</span> <span class="token keyword">begin</span>
        sram_data_t_comb <span class="token operator">=</span> <span class="token number">1'b0</span><span class="token punctuation">;</span>
        sram_data_o_comb <span class="token operator">=</span> <span class="token number">32'b0</span><span class="token punctuation">;</span>
        <span class="token comment">// ...</span>
    <span class="token keyword">end</span>
<span class="token keyword">endmodule</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>当 <code>sram_data_t_comb=1</code> 时, 进入高阻态, 对应读操作, 读取的数据在 <code>sram_data_i_comb</code> 信号; 当 <code>sram_data_t_comb=0</code> 时, 进入输出状态, 对应写操作. 对 SRAM 控制器来说, 只需要在相应状态下设置 <code>sram_data_t_comb</code> 即可. </p>
<p>上面 <code>sram_data_o_comb</code> 和 <code>sram_data_t_comb</code> 也可改用寄存器结合状态机实现: </p>
<pre class="line-numbers language-verilog" data-language="verilog"><code class="language-verilog"><span class="token keyword">module</span> sram_controller <span class="token punctuation">(</span>
    <span class="token keyword">inout</span> <span class="token punctuation">[</span><span class="token number">31</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> sram_data
<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">wire</span> <span class="token punctuation">[</span><span class="token number">31</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> sram_data_i_comb<span class="token punctuation">;</span>
    <span class="token keyword">reg</span> <span class="token punctuation">[</span><span class="token number">31</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> sram_data_o_reg<span class="token punctuation">;</span>
    <span class="token keyword">reg</span> sram_data_t_reg<span class="token punctuation">;</span>

    <span class="token keyword">assign</span> sram_data <span class="token operator">=</span> sram_data_t_reg <span class="token operator">?</span> <span class="token number">32'bz</span> <span class="token punctuation">:</span> sram_data_o_reg<span class="token punctuation">;</span>
    <span class="token keyword">assign</span> sram_data_i_comb <span class="token operator">=</span> sram_data<span class="token punctuation">;</span>

    <span class="token important">always_ff @</span> <span class="token punctuation">(</span><span class="token keyword">posedge</span> clock<span class="token punctuation">)</span> <span class="token keyword">begin</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>reset<span class="token punctuation">)</span> <span class="token keyword">begin</span>
            <span class="token comment">// high-Z when reset</span>
            sram_data_t_reg <span class="token operator">&lt;=</span> <span class="token number">1'b1</span><span class="token punctuation">;</span>
            sram_data_o_reg <span class="token operator">&lt;=</span> <span class="token number">32'b0</span><span class="token punctuation">;</span>
            <span class="token comment">// ...</span>
        <span class="token keyword">end</span> <span class="token keyword">else</span> <span class="token keyword">begin</span>
            <span class="token comment">// ...</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>STB_I <span class="token operator">&amp;&amp;</span> CYC_I <span class="token operator">&amp;&amp;</span> state <span class="token operator">==</span> STATE_IDLE<span class="token punctuation">)</span> <span class="token keyword">begin</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>WE_I<span class="token punctuation">)</span> <span class="token keyword">begin</span>
                    <span class="token comment">// write</span>
                    sram_data_t_reg <span class="token operator">&lt;=</span> <span class="token number">1'b0</span><span class="token punctuation">;</span>
                    sram_data_o_reg <span class="token operator">&lt;=</span> DAT_I<span class="token punctuation">;</span>
                    state <span class="token operator">&lt;=</span> STATE_WRITE<span class="token punctuation">;</span>
                <span class="token keyword">end</span> <span class="token keyword">else</span> <span class="token keyword">begin</span>
                    <span class="token comment">// read</span>
                    sram_data_t_reg <span class="token operator">&lt;=</span> <span class="token number">1'b1</span><span class="token punctuation">;</span>
                    state <span class="token operator">&lt;=</span> STATE_READ<span class="token punctuation">;</span>
                <span class="token keyword">end</span>
            <span class="token keyword">end</span>
        <span class="token keyword">end</span>
    <span class="token keyword">end</span>
<span class="token keyword">endmodule</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">Chengsx</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="http://chengsx21.github.io/2023/10/20/ji-suan-ji-zu-cheng-yuan-li-bi-ji-5/">http://chengsx21.github.io/2023/10/20/ji-suan-ji-zu-cheng-yuan-li-bi-ji-5/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="/about" target="_blank">Chengsx</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/Organization-Design/">
                                    <span class="chip bg-color">Organization &amp; Design</span>
                                </a>
                            
                                <a href="/tags/SV/">
                                    <span class="chip bg-color">SV</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.jpg" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>

            
        </div>
    </div>

    

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2023/10/24/ji-suan-ji-wang-luo-an-quan-ji-zhu-bi-ji-3/">
                    <div class="card-image">
                        
                        <img src="/medias/featureimages/17.jpg" class="responsive-img" alt="计算机网络安全技术 笔记3">
                        
                        <span class="card-title">计算机网络安全技术 笔记3</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            认证技术
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2023-10-24
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/CS/" class="post-category">
                                    CS
                                </a>
                            
                            <a href="/categories/CS/Network-Security/" class="post-category">
                                    Network Security
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Network-Security/">
                        <span class="chip bg-color">Network Security</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2023/10/17/bian-yi-yuan-li-lab-1/">
                    <div class="card-image">
                        
                        <img src="/medias/featureimages/15.jpg" class="responsive-img" alt="编译原理 实验1">
                        
                        <span class="card-title">编译原理 实验1</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            常量表达式
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2023-10-17
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/CS/" class="post-category">
                                    CS
                                </a>
                            
                            <a href="/categories/CS/Compiler/" class="post-category">
                                    Compiler
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Compiler/">
                        <span class="chip bg-color">Compiler</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>


  <!-- 是否加载使用自带的 prismjs. -->
  <script type="text/javascript" src="/libs/prism/prism.min.js"></script>


<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>



    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    

    <div class="container row center-align"
         style="margin-bottom: 15px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2022-2024</span>
            
            <a href="/about" target="_blank">Chengsx</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            
                <span id="translate">|&nbsp;繁/简：</span><a id="translateLink" href="javascript:translatePage();">繁</a>
            
            <br>
            
                &nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span
                        class="white-color">131.8k</span>
            
            
            
                
            
            
                <span id="busuanzi_container_site_pv">
                &nbsp;|&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;
                    <span id="busuanzi_value_site_pv" class="white-color"></span>
            </span>
            
            
                <span id="busuanzi_container_site_uv">
                &nbsp;|&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;
                    <span id="busuanzi_value_site_uv" class="white-color"></span>
            </span>
            
            <br>

            <!-- 运行天数提醒. -->
            
                <span id="sitetime"> Loading ...</span>
                <script>
                    var calcSiteTime = function () {
                        var seconds = 1000;
                        var minutes = seconds * 60;
                        var hours = minutes * 60;
                        var days = hours * 24;
                        var years = days * 365;
                        var today = new Date();
                        var startYear = "2022";
                        var startMonth = "8";
                        var startDate = "26";
                        var startHour = "0";
                        var startMinute = "0";
                        var startSecond = "0";
                        var todayYear = today.getFullYear();
                        var todayMonth = today.getMonth() + 1;
                        var todayDate = today.getDate();
                        var todayHour = today.getHours();
                        var todayMinute = today.getMinutes();
                        var todaySecond = today.getSeconds();
                        var t1 = Date.UTC(startYear, startMonth, startDate, startHour, startMinute, startSecond);
                        var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
                        var diff = t2 - t1;
                        var diffYears = Math.floor(diff / years);
                        var diffDays = Math.floor((diff / days) - diffYears * 365);

                        // 区分是否有年份.
                        var language = 'zh-CN';
                        if (startYear === String(todayYear)) {
                            document.getElementById("year").innerHTML = todayYear;
                            var daysTip = 'This site has been running for ' + diffDays + ' days';
                            if (language === 'zh-CN') {
                                daysTip = '本站已运行 ' + diffDays + ' 天';
                            } else if (language === 'zh-HK') {
                                daysTip = '本站已運行 ' + diffDays + ' 天';
                            }
                            document.getElementById("sitetime").innerHTML = daysTip;
                        } else {
                            document.getElementById("year").innerHTML = startYear + " - " + todayYear;
                            var yearsAndDaysTip = 'This site has been running for ' + diffYears + ' years and '
                                + diffDays + ' days';
                            if (language === 'zh-CN') {
                                yearsAndDaysTip = '本站已运行 ' + diffYears + ' 年 ' + diffDays + ' 天';
                            } else if (language === 'zh-HK') {
                                yearsAndDaysTip = '本站已運行 ' + diffYears + ' 年 ' + diffDays + ' 天';
                            }
                            document.getElementById("sitetime").innerHTML = yearsAndDaysTip;
                        }
                    }

                    calcSiteTime();
                </script>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/chengsx21" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:954738480@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=954738480" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 954738480" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>







    <a href="https://feedly.com/i/subscription/feed/https://endeavor-blog.cn/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 白天和黑夜主题 -->
<div class="stars-con">
    <div id="stars"></div>
    <div id="stars2"></div>
    <div id="stars3"></div>  
</div>

<script>
    function switchNightMode() {
        $('<div class="Cuteen_DarkSky"><div class="Cuteen_DarkPlanet"></div></div>').appendTo($('body')),
        setTimeout(function () {
            $('body').hasClass('DarkMode') 
            ? ($('body').removeClass('DarkMode'), localStorage.setItem('isDark', '0'), $('#sum-moon-icon').removeClass("fa-sun").addClass('fa-moon')) 
            : ($('body').addClass('DarkMode'), localStorage.setItem('isDark', '1'), $('#sum-moon-icon').addClass("fa-sun").removeClass('fa-moon')),
            
            setTimeout(function () {
            $('.Cuteen_DarkSky').fadeOut(1e3, function () {
                $(this).remove()
            })
            }, 2e3)
        })
    }
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    

    
        <script type="text/javascript" src="/js/tw_cn.js"></script>
        <script type="text/javascript">
          var defaultEncoding = 2; //网站编写字体是否繁体，1-繁体，2-简体
          var translateDelay = 0; //延迟时间,若不在前, 要设定延迟翻译时间, 如100表示100ms,默认为0
          var cookieDomain = "http://chengsx21.github.io"; //Cookie地址, 一定要设定, 通常为你的网址
          var msgToTraditionalChinese = "繁"; //此处可以更改为你想要显示的文字
          var msgToSimplifiedChinese = "简"; //同上，但两处均不建议更改
          var translateButtonId = "translateLink"; //默认互换id
          translateInitilization();
        </script>
    
    
    
        
        <script type="text/javascript">
            // 只在桌面版网页启用特效
            var windowWidth = $(window).width();
            if (windowWidth > 768) {
                document.write('<script type="text/javascript" src="/libs/others/sakura.js"><\/script>');
            }
        </script>
    

    <!--单击显示文字-->
    <script type="text/javascript" src="/js/click-show-text.js"></script>

    <!-- 雪花特效 -->
    

    <!-- 鼠标星星特效 -->
    

    

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    <!--腾讯兔小巢-->
    
    
    <script type="text/javascript" color="0,0,255"
        pointColor="0,0,255" opacity='0.7'
        zIndex="-1" count="99"
        src="/libs/background/canvas-nest.js"></script>
    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"log":false,"model":{"jsonPath":"/live2dw/assets/koharu.model.json"},"display":{"position":"left","width":180,"height":300},"mobile":{"show":false,"react":{"opacity":0.7}}});</script></body>

</html>
